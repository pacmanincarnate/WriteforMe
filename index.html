<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovelCraft 2.4 - AI Story Studio</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX Transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Merriweather', serif; }
        
        .nav-btn {
            width: 100%; text-align: left; padding: 0.5rem 0.75rem; border-radius: 0.375rem;
            display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;
            color: #94a3b8; transition: all 0.2s;
        }
        .nav-btn:hover { background-color: #1e293b; color: #f1f5f9; }
        .nav-btn.active { background-color: rgba(79, 70, 229, 0.2); color: #a5b4fc; border: 1px solid rgba(99, 102, 241, 0.3); }
        
        strong { color: #e2e8f0; font-weight: 700; }
        em { color: #94a3b8; font-style: italic; }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px; border-radius: 99px;
            background: #6366f1; cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration
        const apiKey = ""; // Runtime provides this

        // --- ICONS WRAPPER ---
        const Icon = ({ name, className = "w-4 h-4" }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const iconSvg = lucide.createIcons.icons[name];
                    // Fallback to simple circle if icon not found
                }
            }, [name]);
            // For simplicity in CDN version, we use Lucide's replace method
            return <i data-lucide={name} className={className}></i>;
        };

        // Standard Lucide replacement effect
        const useLucide = () => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });
        };

        // --- COMPONENTS ---

        const ValenceGraph = ({ dataPoints, height = 60 }) => {
            if (!dataPoints || dataPoints.length < 2) return null;
            const maxVal = 10;
            const minVal = -10;
            const range = maxVal - minVal;
            const stepX = 100 / (dataPoints.length - 1);
            const points = dataPoints.map((val, idx) => {
                const normalizedY = 100 - ((val - minVal) / range) * 100;
                return `${idx * stepX},${normalizedY}`;
            }).join(' ');
            const zeroY = 100 - ((0 - minVal) / range) * 100;

            return (
                <div className="w-full" style={{ height: `${height}px` }}>
                    <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" className="overflow-visible">
                        <line x1="0" y1={zeroY} x2="100" y2={zeroY} stroke="#475569" strokeWidth="1" strokeDasharray="4" />
                        <polyline points={points} fill="none" stroke="#6366f1" strokeWidth="2" vectorEffect="non-scaling-stroke" />
                    </svg>
                </div>
            );
        };

        const ValenceBadge = ({ score }) => {
            const isPos = score > 0;
            const isNeg = score < 0;
            const color = isPos ? "bg-emerald-900/40 text-emerald-400 border-emerald-900/50" : 
                          isNeg ? "bg-red-900/40 text-red-400 border-red-900/50" : 
                          "bg-slate-700 text-slate-300";
            return (
                <div className={`flex items-center gap-1 text-[10px] font-mono px-2 py-0.5 rounded border ${color}`}>
                    {score > 0 ? '+' : ''}{score}
                </div>
            );
        };

        // --- PROMPTS ---
        const PROMPTS = {
            storyArchitect: `You are a Lead Narrative Designer. Input: A concept. Task: Story Bible. JSON: { concept, threads: [{id, name, description}], protagonist: { name, role, description, voice_sample, details: { history, story_events, goals, evolution } }, world_lore: [{topic, detail}] }`,
            actStructure: `Pacing Expert. Break story into 3 Acts. JSON: { acts: [{ number, title, description, focus_thread_ids }] }`,
            sceneWeaverAct1: `Act 1 Architect. 12-16 scenes. JSON: { scenes: [{ number, title, description, active_thread_ids, location, cast_names, valence }], new_characters: [] }`,
            sceneWeaverAct2: `Act 2 Architect. 18-24 scenes. JSON: { scenes: [...], new_characters: [] }`,
            sceneWeaverAct3: `Act 3 Architect. 10-14 scenes. JSON: { scenes: [...], new_characters: [] }`,
            beatDirector: `Cinematic Director. 6-10 beats. JSON: { beats: [{ number, type, description, emotional_shift, valence }] }`,
            drafter: `Literary Draftsman. 400-600 words. Focus on Show Don't Tell. Plain text.`,
            editor: `Ruthless Editor. Polish draft. Plain text.`,
            archivist: `Story Archivist. Analyze text for Cast Updates and Lore. JSON: { cast_updates: [{ name, append_history, append_story_events, update_goals }], lore_updates: [{ topic, detail }] }`
        };

        // --- MAIN APP ---
        function App() {
            useLucide();
            const [story, setStory] = useState({ concept: "", threads: [], lore: [], cast: [], acts: [], scenes: {}, beats: {}, prose: {} });
            const [view, setView] = useState('setup');
            const [loading, setLoading] = useState(false);
            const [loadingStep, setLoadingStep] = useState("");
            const [selectedAct, setSelectedAct] = useState(null);
            const [selectedScene, setSelectedScene] = useState(null);
            const [inputConcept, setInputConcept] = useState("");
            const [pacing, setPacing] = useState(50);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            const callGemini = async (prompt, systemPrompt, isJson = true) => {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { maxOutputTokens: 8192, temperature: 0.8, ...(isJson ? { responseMimeType: "application/json" } : {}) }
                };
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return isJson ? JSON.parse(text) : text;
            };

            const callTTS = async (text) => {
                const payload = { contents: [{ parts: [{ text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } } };
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                const b64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const binary = window.atob(b64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                
                // WAV Header Construction
                const wavHeader = new ArrayBuffer(44);
                const view = new DataView(wavHeader);
                const writeString = (v, o, s) => { for(let i=0; i<s.length; i++) v.setUint8(o+i, s.charCodeAt(i)); };
                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + bytes.length, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, 24000, true);
                view.setUint32(28, 48000, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(view, 36, 'data');
                view.setUint32(40, bytes.length, true);

                const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
                new Audio(URL.createObjectURL(blob)).play();
            };

            const handleWorldUpdates = (updates) => {
                setStory(prev => {
                    let newCast = [...prev.cast];
                    let newLore = [...prev.lore];
                    if (updates.cast_updates) {
                        updates.cast_updates.forEach(up => {
                            const idx = newCast.findIndex(c => c.name === up.name);
                            if (idx !== -1) {
                                if (!newCast[idx].details) newCast[idx].details = { history: "", story_events: "", goals: "" };
                                if (up.append_history) newCast[idx].details.history += "\n" + up.append_history;
                                if (up.append_story_events) newCast[idx].details.story_events += "\n" + up.append_story_events;
                                if (up.update_goals) newCast[idx].details.goals = up.update_goals;
                            }
                        });
                    }
                    if (updates.new_characters) {
                        updates.new_characters.forEach(nc => { if (!newCast.find(c => c.name === nc.name)) newCast.push(nc); });
                    }
                    if (updates.lore_updates) {
                        updates.lore_updates.forEach(up => { if (!newLore.find(l => l.topic === up.topic)) newLore.push(up); });
                    }
                    return { ...prev, cast: newCast, lore: newLore };
                });
            };

            const initStory = async () => {
                setLoading(true); setLoadingStep("Architecting Story...");
                try {
                    const bible = await callGemini(`Concept: ${inputConcept}`, PROMPTS.storyArchitect);
                    const acts = await callGemini(`Concept: ${bible.concept}`, PROMPTS.actStructure);
                    setStory(s => ({ ...s, ...bible, acts: acts.acts }));
                    setView('dashboard');
                } finally { setLoading(false); }
            };

            const generateScenes = async (idx) => {
                setLoading(true); setLoadingStep("Weaving Scenes...");
                try {
                    const actNum = idx + 1;
                    const sp = actNum === 1 ? PROMPTS.sceneWeaverAct1 : actNum === 2 ? PROMPTS.sceneWeaverAct2 : PROMPTS.sceneWeaverAct3;
                    const res = await callGemini(`Act: ${JSON.stringify(story.acts[idx])}`, sp);
                    setStory(s => ({ ...s, scenes: { ...s.scenes, [idx]: res.scenes } }));
                    handleWorldUpdates(res);
                } finally { setLoading(false); }
            };

            const generateBeats = async (actIdx, sceneIdx) => {
                setLoading(true); setLoadingStep("Directing Beats...");
                try {
                    const res = await callGemini(`Scene: ${JSON.stringify(story.scenes[actIdx][sceneIdx])}`, PROMPTS.beatDirector);
                    setStory(s => ({ ...s, beats: { ...s.beats, [`${actIdx}-${sceneIdx}`]: res.beats } }));
                    setSelectedScene(sceneIdx);
                } finally { setLoading(false); }
            };

            const writeProse = async (actIdx, sceneIdx, beatIdx) => {
                setLoading(true);
                const sId = `${actIdx}-${sceneIdx}`;
                const bId = `${sId}-${beatIdx}`;
                try {
                    setLoadingStep("Drafting...");
                    const draft = await callGemini(`Beat: ${story.beats[sId][beatIdx].description}`, PROMPTS.drafter, false);
                    setLoadingStep("Polishing...");
                    const final = await callGemini(`Text: ${draft}`, PROMPTS.editor, false);
                    setLoadingStep("Archiving...");
                    const up = await callGemini(`Text: ${final}`, PROMPTS.archivist);
                    handleWorldUpdates(up);
                    setStory(s => ({ ...s, prose: { ...s.prose, [bId]: { final } } }));
                } finally { setLoading(false); }
            };

            const copyScene = () => {
                const sId = `${selectedAct}-${selectedScene}`;
                const text = story.beats[sId].map((_, i) => story.prose[`${sId}-${i}`]?.final || "").join("\n\n");
                const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                alert("Copied!");
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 left-0 z-50 w-72 bg-slate-900 border-r border-slate-800 flex flex-col transition-transform md:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h1 className="font-bold flex items-center gap-2"><i data-lucide="book" className="text-indigo-400"></i> NovelCraft</h1>
                            <button onClick={() => setIsSidebarOpen(false)} className="md:hidden"><i data-lucide="x"></i></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            <button onClick={() => setView('dashboard')} className={`nav-btn ${view === 'dashboard' ? 'active' : ''}`}><i data-lucide="activity"></i> Overview</button>
                            <button onClick={() => setView('cast')} className={`nav-btn ${view === 'cast' ? 'active' : ''}`}><i data-lucide="users"></i> Cast</button>
                            <button onClick={() => setView('structure')} className={`nav-btn ${view === 'structure' ? 'active' : ''}`}><i data-lucide="layers"></i> Structure</button>
                            <div className="pt-4 border-t border-slate-800">
                                {story.acts.map((act, idx) => (
                                    <div key={idx} className="mb-2">
                                        <div className="text-[10px] uppercase text-slate-500 mb-1 px-2">Act {idx+1}</div>
                                        {story.scenes[idx]?.map((s, si) => (
                                            <button key={si} onClick={() => { setSelectedAct(idx); setSelectedScene(si); setView('writer'); setIsSidebarOpen(false); }} className="nav-btn text-xs pl-4 truncate">{s.title}</button>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Main */}
                    <div className="flex-1 flex flex-col min-w-0 md:ml-72">
                        <header className="h-16 border-b border-slate-800 px-6 flex items-center justify-between">
                            <button onClick={() => setIsSidebarOpen(true)} className="md:hidden"><i data-lucide="menu"></i></button>
                            <div className="flex items-center gap-4">
                                <h2 className="font-bold capitalize">{view}</h2>
                                {loading && <div className="text-xs text-indigo-400 animate-pulse">{loadingStep}</div>}
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-8 bg-slate-950">
                            {view === 'setup' && (
                                <div className="max-w-xl mx-auto py-20 text-center">
                                    <h2 className="text-3xl font-bold mb-6">Start Your Novel</h2>
                                    <textarea className="w-full h-40 bg-slate-900 border border-slate-800 p-4 rounded-xl mb-6 outline-none focus:border-indigo-500" placeholder="A world where..." value={inputConcept} onChange={e => setInputConcept(e.target.value)} />
                                    <button onClick={initStory} className="bg-indigo-600 w-full py-4 rounded-xl font-bold hover:bg-indigo-500">Initialize Studio</button>
                                </div>
                            )}

                            {view === 'dashboard' && (
                                <div className="max-w-4xl mx-auto space-y-8 animate-fade-in">
                                    <div className="bg-slate-900 p-6 rounded-xl border border-slate-800">
                                        <h3 className="text-indigo-400 text-xs font-bold uppercase mb-2">Concept</h3>
                                        <p className="text-xl leading-relaxed">{story.concept}</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="bg-slate-900 p-6 rounded-xl border border-slate-800">
                                            <h3 className="text-emerald-400 text-xs font-bold mb-4">Threads</h3>
                                            {story.threads.map(t => <div key={t.id} className="mb-2 text-sm"><strong>{t.name}:</strong> {t.description}</div>)}
                                        </div>
                                        <div className="bg-slate-900 p-6 rounded-xl border border-slate-800">
                                            <h3 className="text-blue-400 text-xs font-bold mb-4">Lore</h3>
                                            {story.lore.slice(0, 5).map((l, i) => <div key={i} className="text-sm"><strong>{l.topic}:</strong> {l.detail}</div>)}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'cast' && (
                                <div className="grid grid-cols-2 gap-6 max-w-6xl mx-auto animate-fade-in">
                                    {story.cast.map((c, i) => (
                                        <div key={i} className="bg-slate-900 p-6 rounded-xl border border-slate-800">
                                            <h3 className="text-xl font-bold text-white">{c.name}</h3>
                                            <div className="text-xs text-indigo-400 mb-4">{c.role}</div>
                                            <div className="space-y-4">
                                                <div className="text-sm"><strong>History:</strong> {c.details?.history}</div>
                                                <div className="text-sm"><strong>Events:</strong> {c.details?.story_events}</div>
                                                <div className="text-sm italic">"{c.voice_sample}"</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {view === 'structure' && (
                                <div className="max-w-4xl mx-auto space-y-6 animate-fade-in">
                                    {story.acts.map((act, i) => (
                                        <div key={i} className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
                                            <div className="p-6 bg-slate-800/30 flex justify-between items-center">
                                                <div>
                                                    <div className="text-xs text-slate-500 uppercase">Act {i+1}</div>
                                                    <h3 className="text-xl font-bold">{act.title}</h3>
                                                </div>
                                                {!story.scenes[i] && <button onClick={() => generateScenes(i)} className="bg-indigo-600 px-4 py-2 rounded-lg text-sm">Weave Scenes</button>}
                                            </div>
                                            {story.scenes[i] && (
                                                <div className="divide-y divide-slate-800">
                                                    {story.scenes[i].map((s, si) => (
                                                        <div key={si} className="p-4 flex items-center justify-between hover:bg-slate-800/20">
                                                            <div>
                                                                <h4 className="font-bold">{s.number}. {s.title}</h4>
                                                                <p className="text-xs text-slate-500">{s.description}</p>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <ValenceBadge score={s.valence} />
                                                                <button onClick={() => { setSelectedAct(i); setSelectedScene(si); setView('writer'); }} className="text-indigo-400 hover:text-white"><i data-lucide="edit-3" className="w-4 h-4"></i></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {view === 'writer' && selectedAct !== null && selectedScene !== null && (
                                <div className="max-w-6xl mx-auto space-y-8 animate-fade-in">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h2 className="text-2xl font-bold">{story.scenes[selectedAct][selectedScene].title}</h2>
                                            <p className="text-slate-500">{story.scenes[selectedAct][selectedScene].description}</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={copyScene} className="bg-slate-800 p-2 rounded"><i data-lucide="copy" className="w-4 h-4"></i></button>
                                            {!story.beats[`${selectedAct}-${selectedScene}`] && <button onClick={() => generateBeats(selectedAct, selectedScene)} className="bg-emerald-600 px-4 py-2 rounded-lg font-bold">Direct Beats</button>}
                                        </div>
                                    </div>

                                    <div className="space-y-12">
                                        {story.beats[`${selectedAct}-${selectedScene}`]?.map((beat, bi) => {
                                            const bId = `${selectedAct}-${selectedScene}-${bi}`;
                                            const prose = story.prose[bId];
                                            return (
                                                <div key={bi} className="flex gap-8">
                                                    <div className="w-80 shrink-0">
                                                        <div className={`p-4 rounded-xl border ${prose ? 'bg-slate-900/40 border-slate-800 opacity-60' : 'bg-slate-900 border-indigo-500/30'}`}>
                                                            <div className="text-[10px] font-mono mb-2">BEAT {bi+1} - {beat.type}</div>
                                                            <p className="text-sm mb-4">{beat.description}</p>
                                                            {!prose && <button onClick={() => writeProse(selectedAct, selectedScene, bi)} className="bg-indigo-600 w-full py-2 rounded-lg text-sm font-bold">Write Beat</button>}
                                                        </div>
                                                    </div>
                                                    <div className="flex-1">
                                                        {prose ? (
                                                            <div className="relative group">
                                                                <div className="font-serif text-lg leading-loose space-y-4" dangerouslySetInnerHTML={{ __html: parseMarkdown(prose.final) }} />
                                                                <button onClick={() => callTTS(prose.final)} className="absolute top-0 -right-8 opacity-0 group-hover:opacity-100 transition-opacity text-emerald-400"><i data-lucide="volume-2"></i></button>
                                                            </div>
                                                        ) : <div className="h-full border-l border-slate-800 pl-8 flex items-center text-slate-700 italic">Waiting...</div>}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
